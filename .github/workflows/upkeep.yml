# Code generated by dhall-to-yaml.  DO NOT EDIT.
jobs:
  augmax:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.augmax.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.augmax
        working-directory: "./nixpkgs-upkeep"
  flax:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.flax.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.flax
        working-directory: "./nixpkgs-upkeep"
  ipython:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.ipython.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.ipython
        working-directory: "./nixpkgs-upkeep"
  jax:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.jax.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.jax
        working-directory: "./nixpkgs-upkeep"
  jaxlib:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.jaxlib.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.jaxlib
        working-directory: "./nixpkgs-upkeep"
  jaxlib-bin:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.jaxlib-bin.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.jaxlib-bin
        working-directory: "./nixpkgs-upkeep"
  jaxlib-bin-cuda:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - run: |
          NIX_PATH=.. nix-build -E "with import <nixpkgs> {}; python3Packages.jaxlib-bin.override { cudaSupport = true; }"
        working-directory: "./nixpkgs"
  jaxlibWithCuda:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.jaxlibWithCuda.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.jaxlibWithCuda
        working-directory: "./nixpkgs-upkeep"
  matplotlib:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.matplotlib.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.matplotlib
        working-directory: "./nixpkgs-upkeep"
      - name: Run custom update-script
        run: |
          cp ./nixpkgs-upkeep/update-matplotlib.py ./nixpkgs/pkgs/development/python-modules/matplotlib
          chmod +x ./nixpkgs/pkgs/development/python-modules/matplotlib/update-matplotlib.py
          ./nixpkgs/pkgs/development/python-modules/matplotlib/update-matplotlib.py
          rm ./nixpkgs/pkgs/development/python-modules/matplotlib/update-matplotlib.py
      - run: git diff
        working-directory: "./nixpkgs"
      - run: nix-build -A python3Packages.matplotlib
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: Create PR
        run: |
          GH_TOKEN="$GH_TOKEN" \
            TARGET_BRANCH="staging" \
            PACKAGE="python3Packages.matplotlib" \
            PRE_VERSION="$PRE_VERSION" \
            TESTED_OTHER_LINUX="true" \
            GITHUB_WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            ./../nixpkgs-upkeep/create-pr.sh
        working-directory: "./nixpkgs"
  optax:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.optax.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.optax
        working-directory: "./nixpkgs-upkeep"
  pandas:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.pandas.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.pandas
        working-directory: "./nixpkgs-upkeep"
  plexamp:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version before update script
        run: |
          PRE_VERSION="$(nix-instantiate --eval -E "with import ./. {}; lib.getVersion plexamp" --json | jq -r)"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - run: "./nixpkgs/pkgs/applications/audio/plexamp/update-plexamp.sh"
      - run: git diff
        working-directory: "./nixpkgs"
      - run: nix-build -A plexamp
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: Create PR
        run: |
          GH_TOKEN="$GH_TOKEN" \
            TARGET_BRANCH="master" \
            PACKAGE="plexamp" \
            PRE_VERSION="$PRE_VERSION" \
            TESTED_OTHER_LINUX="true" \
            GITHUB_WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            ./../nixpkgs-upkeep/create-pr.sh
        working-directory: "./nixpkgs"
  plotly:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.plotly.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.plotly
        working-directory: "./nixpkgs-upkeep"
  pytorch:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.pytorch.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.pytorch
        working-directory: "./nixpkgs-upkeep"
  pytorch-bin:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.pytorch-bin.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.pytorch-bin
        working-directory: "./nixpkgs-upkeep"
  pytorchWithCuda:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.pytorchWithCuda.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.pytorchWithCuda
        working-directory: "./nixpkgs-upkeep"
  spotify:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . spotify-unwrapped.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - name: Run custom update-script
        run: |
          git config --global user.email "foo@bar.com"
          git config --global user.name "upkeep-bot"
          before_commit=$(git rev-parse HEAD)
          ./pkgs/applications/audio/spotify/update.sh
          after_commit=$(git rev-parse HEAD)
          if [ $before_commit != $after_commit ]; then
            git reset "HEAD^"
          fi
        working-directory: "./nixpkgs"
      - run: git diff
        working-directory: "./nixpkgs"
      - run: nix-build -A spotify
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: Create PR
        run: |
          GH_TOKEN="$GH_TOKEN" \
            TARGET_BRANCH="master" \
            PACKAGE="spotify-unwrapped" \
            PRE_VERSION="$PRE_VERSION" \
            TESTED_OTHER_LINUX="true" \
            GITHUB_WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            ./../nixpkgs-upkeep/create-pr.sh
        working-directory: "./nixpkgs"
  tensorflow:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.tensorflow.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.tensorflow
        working-directory: "./nixpkgs-upkeep"
  tensorflow-bin:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.tensorflow-bin.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.tensorflow-bin
        working-directory: "./nixpkgs-upkeep"
  tensorflow-bin-cuda:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - run: |
          NIX_PATH=.. nix-build -E "with import <nixpkgs> {}; python3Packages.tensorflow-bin.override { cudaSupport = true; }"
        working-directory: "./nixpkgs"
  tensorflow-datasets:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.tensorflow-datasets.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.tensorflow-datasets
        working-directory: "./nixpkgs-upkeep"
  torchvision:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.torchvision.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.torchvision
        working-directory: "./nixpkgs-upkeep"
  tqdm:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.tqdm.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.tqdm
        working-directory: "./nixpkgs-upkeep"
  vscode:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . vscode.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - run: "./nixpkgs/pkgs/applications/editors/vscode/update-vscode.sh"
      - run: git diff
        working-directory: "./nixpkgs"
      - run: nix-build -A vscode
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: Create PR
        run: |
          GH_TOKEN="$GH_TOKEN" \
            TARGET_BRANCH="master" \
            PACKAGE="vscode" \
            PRE_VERSION="$PRE_VERSION" \
            TESTED_OTHER_LINUX="true" \
            GITHUB_WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            ./../nixpkgs-upkeep/create-pr.sh
        working-directory: "./nixpkgs"
  vscodium:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . vscodium.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - run: "./nixpkgs/pkgs/applications/editors/vscode/update-vscodium.sh"
      - run: git diff
        working-directory: "./nixpkgs"
      - run: nix-build -A vscodium
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: Create PR
        run: |
          GH_TOKEN="$GH_TOKEN" \
            TARGET_BRANCH="master" \
            PACKAGE="vscodium" \
            PRE_VERSION="$PRE_VERSION" \
            TESTED_OTHER_LINUX="true" \
            GITHUB_WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            ./../nixpkgs-upkeep/create-pr.sh
        working-directory: "./nixpkgs"
  wandb:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . python3Packages.wandb.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr python3Packages.wandb
        working-directory: "./nixpkgs-upkeep"
      - name: Run custom update-script
        run: |
          cp ./nixpkgs-upkeep/update-wandb.py ./nixpkgs/pkgs/development/python-modules/wandb
          chmod +x ./nixpkgs/pkgs/development/python-modules/wandb/update-wandb.py
          ./nixpkgs/pkgs/development/python-modules/wandb/update-wandb.py
          rm ./nixpkgs/pkgs/development/python-modules/wandb/update-wandb.py
      - run: git diff
        working-directory: "./nixpkgs"
      - run: nix-build -A python3Packages.wandb
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: Create PR
        run: |
          GH_TOKEN="$GH_TOKEN" \
            TARGET_BRANCH="master" \
            PACKAGE="python3Packages.wandb" \
            PRE_VERSION="$PRE_VERSION" \
            TESTED_OTHER_LINUX="true" \
            GITHUB_WORKFLOW_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            ./../nixpkgs-upkeep/create-pr.sh
        working-directory: "./nixpkgs"
  yapf:
    runs-on: ubuntu-latest
    steps:
      - run: lscpu
      - uses: "cachix/install-nix-action@v16"
        with:
          extra_nix_config: experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable
      - name: nix-info
        run: "nix-shell -p nix-info --run 'nix-info -m'"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: ploop
      - name: Checkout nixpkgs-upkeep
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs-upkeep
      - name: Checkout nixpkgs
        uses: "actions/checkout@v2"
        with:
          path: nixpkgs
          repository: NixOS/nixpkgs
          token: "${{ secrets.GH_TOKEN }}"
      - name: Add CUDA/MKL overlay
        run: |
          mkdir -p ~/.config/nixpkgs/overlays/
          cp ./nixpkgs-upkeep/overlay.nix ~/.config/nixpkgs/overlays/
      - name: Allow unfree
        run: |
          mkdir -p ~/.config/nixpkgs/
          echo "{ allowUnfree = true; }" > ~/.config/nixpkgs/config.nix
      - name: Check current package version
        run: |
          PRE_VERSION="$(nix eval --raw --file . yapf.version)"
          echo "Current version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV
        working-directory: "./nixpkgs"
      - env:
          GH_TOKEN: "${{ secrets.GH_TOKEN }}"
        name: build canary
        run: |
          GH_TOKEN=$GH_TOKEN ./canary.py --nixpkgs ../nixpkgs --attr yapf
        working-directory: "./nixpkgs-upkeep"
name: upkeep
on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * *"
